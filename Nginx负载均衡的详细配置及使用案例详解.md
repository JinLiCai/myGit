# Nginx负载均衡的详细配置及使用案例详解



**技术无止境, 我们仍需努力!** 

**1,话不多说, 这里我们来说下很重要的负载均衡, 那么什么是负载均衡呢?** 

由于目前现有网络的各个核心部分随着业务量的提高，访问量和数据流量的快速增长，其处理能力和计算强度也相应地增大，使得单一的服务器设备根本无法承担。在此情况下，如果扔掉现有设备去做大量的硬件升级，这样将造成现有资源的浪费，而且如果再面临下一次业务量的提升时，这又将导致再一次硬件升级的高额成本投入，甚至性能再卓越的设备也不能满足当前业务量增长的需求。 
针对此情况而衍生出来的一种廉价有效透明的方法以扩展现有网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性的技术就是负载均衡（Load Balance）。


**2, 负载均衡的种类**

1）一种是通过硬件来进行解决，常见的硬件有NetScaler、F5、Radware和Array等商用的负载均衡器，但是它们是比较昂贵的
2）一种是通过软件来进行解决的，常见的软件有LVS、Nginx、apache等,它们是基于Linux系统并且开源的负载均衡策略.

**3, 这里我们只来说Nginx(其他的大家有兴趣可以自行查阅相关文档)**

Nginx（发音同 engine x）是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD-like 协议下发行。由俄罗斯的程序设计师Igor Sysoev(伊戈尔·西索夫)所开发，供俄国大型的入口网站及搜索引擎Rambler(漫步者)（俄文：Рамблер）使用。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：新浪、网易、 腾讯等。
优点：
1:可运行linux,并有 Windows 移植版。
2:在高连接并发的情况下，Nginx是Apache服务器不错的替代品Nginx在美国是做虚拟主机生意的老板们经常选择的软件平台之一。能够支持高达 50,000 个并发连接数的响应

**4, 创建两台Nginx服务器**由于自己在自己电脑上搭建, 所以 现在只模拟搭建两台Nginx服务器. 



负载均衡的功能:
转发
故障移除
恢复添加
高可用 Ha

我们想要使用Nginx那么就必须满足上面的四个条件.
我们配置负载均衡的目的是在于当用户访问我们的服务器的时候, 首先会通过 Nginx服务器来决定转发到哪个Tomcat服务器上去给用户提供服务, 当然这个概率是我们通过权重来配置的. 经过Nginx指派之后, 我们就可以处理高并发的访问了, 这里就能达到负载均衡的目的.


**5, 搭建Nginx**首先我们需要大家两台机器, 两台机器分别安装了Nginx和Tomcat, IP分别为: 192.168.200.129. 192.168.200.130**![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095215372-820537954.png)![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095133603-359949506.png)**

接着我们需要将Nginx和Tomcat包分别拷贝到CentOS01和CentOS02上, 并且解压好, 这里就不再复述这个过程了.然后我们需要关闭Linux的防火墙, 否则的话启动了Nginx也是连接不上的.
![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095353941-876922696.png)

我们还是来再看下解压吧:
![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095555434-96799018.png)

解压完之后我们需要编译安装:

```
 1 ./configure \
 2 --prefix=/usr/local/nginx \
 3 --pid-path=/var/run/nginx/nginx.pid \
 4 --lock-path=/var/lock/nginx.lock \
 5 --error-log-path=/var/log/nginx/error.log \
 6 --http-log-path=/var/log/nginx/access.log \
 7 --with-http_gzip_static_module \
 8 --http-client-body-temp-path=/var/temp/nginx/client \
 9 --http-proxy-temp-path=/var/temp/nginx/proxy \
10 --http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
11 --http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
12 --http-scgi-temp-path=/var/temp/nginx/scgi
```

注意：上边将临时文件目录指定为/var/temp/nginx，需要在/var下创建temp及nginx目录
mkdir -p /var/temp/nginx
![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095719487-1065862113.png)

生成了文件夹后我们直接拷贝上面的编译安装命令进行安装.



**执行完上诉步骤后, 我们可以看到nginx目录下生成了Makefile文件,我们接着往下: ![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095516478-159541286.png)然后使用Make命令, 运行结束后在使用Make install命令进行安装, 最后是启动Nginx:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095930934-762261464.png)查看是否启动成功:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911095945403-499831835.png)配置反向服务代理器:**什么是反向服务呢? 首先说下正向服务, 例如爬虫程序, 我们主动出击去获取资源. 而反向服务我们是等待用户来访问. 区别在于主动和被动.
**配置文件Nginx/conf/nginx.conf![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100310918-150321124.png)配置Nginx转发条件![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100324075-382545535.png)重启Nginx服务器![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100359124-1422736501.png)为了测试, 我们在两个Tomcat 服务器的index.jsp中分别加了这是来自于哪个ip下的Tomcat. 如下图所示:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100503863-1369713667.png)![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100513989-2081772107.png)重启好Nginx后, 我们再来访问192.168.200.129 这台机器, 我么可以发现其实访问的是129.168.200.130这台机器.![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100541507-194477873.png)负债均衡的配置, 配置转发的权重: (另一台CentOS02 依然按照CentOS01的配置)![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100714388-1672984788.png)我们在这里配置了两台转发机器: 192.168.200.129和192.168.200.130, 它们的权重分别是2/3 和1/3, 也就是说访问三次192.168.200.129, 有两次是192.168.200.129上的Tomcat来处理, 有一次是192.168.200.130上的Tomcat来处理. 如果我们的Tomcat服务器更多 那么就需要在这里配置更多, 权重根据实际需求来划分.同上, 搭建另一台机器192.168.200.130的负载均衡:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911100954946-644051309.png)搭建Keepalived:(Keepalived需要依赖openssl)这里如果我们的机器192.168.200.129 出现故障了呢? 那么怎么使用192.168.200.130上的Nginx进行转发呢? 怎么设置主机和备机呢? 如果主机死了怎么进行故障移除呢?　如果主机从不可用到可用状态又怎么进行恢复添加呢? 这些功能都是可以通过Keepalived来进行设置的.![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911101217316-361080627.png)Keepalived原理:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102904043-793173641.png)首先Keepalived可以在主机上产生一个虚拟的ip, 这里叫做vip(v是virtual的意思):192.168.200.150, keepalived会将这个vip绑定到交换机上.当用户访问主机:192.168.200.129时, 交换机会通过这个ip和vip的对应找到192.168.200.129上的Nginx进行处理.如果当有一天192.168.200.129上的Nginx挂掉的时候, Keepalived会立即在备机上生成一个相同的vip: 192.168.200.150, 当用户继续访问192.168.200.129时, 交换机上已经绑定了vip, 这时发现这个vip是存在于192.168.200.130上面的, 所以直接将请求转发到了备机上. 如果主机被修复好能够继续对外提供服务时, 这时keepalived会将主机上继续生成这个vip, 同时回收在备机上生成的vip. 这个是通过心跳检查来判断主机已恢复使用.我这里已经提前安装好了oppenssl, 关于具体安装方法大家可以自行百度. 检查openssl 是否安装成功: ![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911101042778-367884877.png)**

**Keepalived的安装命令:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911101701070-831958207.png)查看Keepalived的安装目录:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911101730353-1451614339.png)编辑Keepalived的配置文件:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911101752777-1781625661.png)**

**首先我们来清空配置文件(清空后会自动再生成一个keepalived.conf, 但是里面的内容为空)关于为什么要清空, 因为我们已经配置好了一些相关内容, 直接使用即可.![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102020444-252966136.png)**

 

**这里是来设置虚拟IP和eth1:因为我的CentOS是拷贝过来的, 所以这里是eth1, 关于怎么查看, 我们在文章开头有查看本机ip: ifconfig, 那里面有显示我们的网卡就是eth1.![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911104316619-1691764963.png)![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911101809247-1083982815.png)配置完成之后, 启动keepalived:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102159013-1143290845.png)检测Keepalived是否启动成功:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102234031-888458840.png)这里查看 我们的机器多了两个ip, 其实这两个ip都是虚拟ip设置备机:|这里的权重只要低于主机的100就好.![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102315378-2061747446.png)启动备机的Keepalived:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102338723-1652686279.png)当主机停止服务时, 备机即可接管继续服务:![img](https://images2015.cnblogs.com/blog/799093/201609/799093-20160911102359162-215650124.png)关于Nginx的内容大概就是这么多了, 我这里是一步步配置且通过验证的, 如果大家哪里有疑问都可以回复留言.**